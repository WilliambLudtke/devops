// Capturar os parâmetros passados pelo Zabbix
var args = process.argv.slice(2);

if (args.length !== 3) {
    console.error("Erro: Parâmetros inválidos. Uso: script.js <usuario> <senha> <url>");
    process.exit(1);
}

var USERNAME = args[0];
var PASSWORD = args[1];
var VRNI_MANAGER = args[2];

var URL_LOGIN = VRNI_MANAGER + '/api/v1/login';
var URL_NODES = VRNI_MANAGER + '/api/ni/entities/nsxt-transport-nodes';

function authenticate() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', URL_LOGIN, false);  // A requisição síncrona
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({ username: USERNAME, password: PASSWORD }));

    if (xhr.status !== 200) {
        console.error('Erro ao autenticar: ' + xhr.status + ' - ' + xhr.responseText);
        process.exit(1);
    }

    var data = JSON.parse(xhr.responseText);
    return data.token;
}

function getTransportNodes(token) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', URL_NODES, false);  // A requisição síncrona
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
    xhr.send();

    if (xhr.status !== 200) {
        console.error('Erro ao obter nodes: ' + xhr.status + ' - ' + xhr.responseText);
        process.exit(1);
    }

    var data = JSON.parse(xhr.responseText);
    return data.results || [];
}

function main() {
    try {
        var token = authenticate();
        var nodes = getTransportNodes(token);

        nodes.forEach(function(node) {
            console.log(node.name + ',' + node.id);
        });
    } catch (error) {
        console.error('Erro no fluxo principal: ' + error.message);
        process.exit(1);
    }
}

main();
